---
title: Linux下C++静态库和动态库
date: 2018-06-16 11:04:49
tags: 学习笔记
category: Linux
---
我们在开发时，有一个基本原则：不要重复造轮子。
<!--more-->
怎么避免重复造轮子，那就是把经常使用的代码编译为库文件。库文件还有一个优点就是防止代码泄漏。

### 什么是库

我们知道，C/C++ 源程序需要经过预处理、编译、汇编和链接这几个步骤把源程序转换为二进制可执行文件才能被计算机执行。链接需要把我们编译生成的多个二进制 .o 目标文件和库文件链接为一个可执行文件。既然库文件可以和目标文件一起被链接，那它的本质就是二进制文件，也可以简单的看作是多个目标文件的集合。

### 静态库

在链接时将目标文件与库一起链接打包到可执行文件中，这种方式就静态链接，相应的库成为静态库。
在 Linux 下，可以使用 g++ 和 ar 工具制作和使用静态库，具体过程如下：

1. 将代码编译为目标文件

``` shell
g++ -c -o sum.o sum.cc
```

2. 使用 ar 工具把目标文件打包成 .a 静态库文件

``` shell
ar -crv libsum.a sum.o
```

3. 编译时指定静态库路径和库名

``` shell
g++ test.cc -L ./ -lsum
```

> 静态库命名规范

Linux下静态库命名分为三部分 libxxx.a, lib 为前缀，xxx 为静态库名，.a 为后缀名

> 编译时参数说明

-L 表示库文件所在的目录
-l 表示库的文件名，不需要前缀和后缀

### 创建和使用动态库

有了静态库，为什么还需要动态库。这是由于静态库的特点导致的。

- 静态库会浪费空间，如果有多个程序同时引用了静态库，那静态库就需要在内存中存在多份
- 静态库更新了程序需要重新编译

动态链接库的特点

- 动态链接库在编译时并不会被链接到可执行文件中，而是在运行时载入
- 动态链接库更新了，程序不需要重新编译

创建动态库的过程。

1. 将代码编译为目标文件

``` shell
g++ -c -o sum.o
```

2. 生成动态库

``` shell
g++ -shared -fPIC -o libsub.so sum.o
```

3. 编译时链接动态库

``` shell
g++ test.cc -L ./ -lsub
```

此时去执行可执行文件，会打印出一行出错日志，找不到动态库，只需要把当前工作目录添加到环境变量 LD_LIBRARY_PATH
临时添加，关闭终端会失效

``` shell
export LD_LIBRARY_PATH=`pwd`
```

永远添加, 在 .bashrc 中添加上面的命令,或者

``` shell
echo `pwd` >> /etc/ld.so.conf
ldconfig
```